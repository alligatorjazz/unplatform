---
import DatabaseView from "../components/DatabaseView.astro";
import TotalEntries from "../components/TotalEntries.astro";
import Main from "../layouts/Main.astro";
import { getCollection } from "astro:content";
import type { Recommendation } from "../types";
import { filterDatabaseEntries } from "../lib";
import { convertQueryToFilters } from "../lib/query";

export const prerender = false;
export async function queryDatabase(
	querystring: string,
): Promise<Recommendation[]> {
	const filters = convertQueryToFilters(querystring.substring(1));
	console.log("remote filters: ", filters);
	const entries = filterDatabaseEntries(
		await getCollection("recommendations"),
		filters,
	);
	return entries.map(({ data }) => data);
}

if (
	Astro.request.headers.get("Accept") === "application/json" &&
	Astro.request.method === "GET"
) {
	return new Response(
		JSON.stringify(await queryDatabase(Astro.url.search), null, 4),
		{
			status: 200,
			headers: {
				"Content-Type": "application/json",
			},
		},
	);
}
---

<Main
	title="Home"
	description="The definitive guide for escaping social media (and joining the indie web.)"
>
	<div
		class="flex flex-col items-center bg-bg border border-text max-w-4xl mx-auto p-4"
	>
		<p class="text-sm text-center mb-4 max-w-xl">
			See our full list of over <TotalEntries round /> recommendations for newsletters,
			social networks, digital tools, and more.
		</p>
		<DatabaseView enableQuerySyncing title="Recommendations" />
		<blockquote class="text-center mb-4">
			Note: "Free" and "Paid" are referring to the cost of the site's content or
			software - not necessarily things like tickets for IRL events,
			organization dues, or other non-digital costs.
		</blockquote>
		<p class="text-sm text-center mb-4">
			Do you know of a website, application, or organization we should add here,
			or do you see something here that's inaccurate / out of date? Let me know
			at <a href="mailto:unplatform@fromthesuperhighway.com"
				>unplatform@fromthesuperhighway.com</a
			>!
		</p>
	</div>
</Main>
